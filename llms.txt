# PXVG (Pixel Vector Graphics)
> PXVG là một ngôn ngữ đánh dấu (Markup Language) dựa trên XML, được thiết kế đặc biệt làm mã trung gian (Static IR) để định nghĩa và sinh hình ảnh Pixel Art. PXVG cho phép định nghĩa các khối, đường nét, điểm ảnh lẻ và các hình học ngữ nghĩa một cách ngắn gọn, tối ưu hóa kích thước chuỗi (Token) và đảm bảo an toàn tuyệt đối khi parse.

## Cấu trúc gốc
Mọi file PXVG (lưu với đuôi `.pxvg.xml`) phải được bao bọc trong thẻ `<pxvg>` với các thuộc tính kích thước Canvas.
```xml
<pxvg w="32" h="32" xmlns="http://pixci.dev/pxvg">
  <!-- Nội dung bản vẽ -->
</pxvg>
```

## Bảng màu (Palette)
Định nghĩa các mã màu sử dụng trong bản vẽ. Có hai cách:
1. Sử dụng palette có sẵn (ví dụ: `endesga-32`, `pico-8`):
   `<palette load="endesga-32" />`
2. Tự định nghĩa các màu cụ thể (gắn mã key 1 ký tự để tiết kiệm token khi gọi):
   ```xml
   <palette>
     <color k="A" hex="#1C1C1EFF" />
     <color k="B" hex="#FF0000FF" />
   </palette>
   ```

## Hệ thống Lớp (Layers)
Các đối tượng đồ họa được phân rã theo lớp để quản lý trật tự vẽ (overlap). Các thẻ vẽ phải nằm trong thẻ `<layer>`.
```xml
<layer id="main">
  <!-- Chi tiết nét vẽ -->
</layer>
```

## Các Thẻ Hình Học Cơ Bản (Primitives)
Các thẻ dùng để đổ màu lên ma trận điểm ảnh với tọa độ bắt buộc là **số nguyên (Integer)**.
- **`<rect>`**: Hình chữ nhật đặc.
  *Thuộc tính:* `x`, `y` (tọa độ góc trái trên), `w` (rộng), `h` (cao), `c` (mã màu).
- **`<row>`**: Chuỗi điểm ngang kéo dài liên tục trên 1 hàng y. (Dùng để tối ưu token).
  *Thuộc tính:* `y` (hàng), `x1` (cột bắt đầu), `x2` (cột kết thúc), `c` (mã màu).
- **`<dot>`**: Một điểm ảnh đơn lẻ.
  *Thuộc tính:* `x`, `y`, `c` (mã màu).
- **`<dots>`**: Tập hợp nhiều điểm ảnh đơn lẻ dùng chung một màu (siêu nén).
  *Thuộc tính:* `c` (mã màu), `pts` (chuỗi tọa độ "x,y x,y...").
- **`<line>`**: Đường thẳng vẽ bằng thuật toán Bresenham.
  *Thuộc tính:* `x1`, `y1` (Bắt đầu), `x2`, `y2` (Kết thúc), `c` (mã màu).
- **`<circle>`**: Hình tròn bán kính r (không khử răng cưa).
  *Thuộc tính:* `cx`, `cy` (tâm), `r` (bán kính), `c` (mã màu).
- **`<polygon>`**: Đa giác đặc.
  *Thuộc tính:* `pts` (chuỗi điểm "x,y x,y..."), `c` (mã màu).

## Các Thẻ Khối Hình Ngữ Nghĩa (Semantic Shapes)
Giúp định nghĩa nhanh các cấu trúc dạng hữu cơ mà không cần nhổ từng pixel.
- **`<dome>`**: Hình vòm hoặc nửa Elip (tốt cho nấm, mũ, nửa hình tròn).
  *Thuộc tính:* `cx` (Tâm x), `y` (Tọa độ y của đáy vòm), `w` (Chiều rộng tối đa), `h` (Chiều cao đỉnh), `c` (mã màu).
- **`<taper>`**: Khối thuôn nhọn từ 2 đầu (tốt cho rễ, sừng, kiếm, thân cành).
  *Thuộc tính:* `cx` (Tâm x), `y1` (Tọa độ y trên), `y2` (Tọa độ y dưới), `w1` (Rộng trên), `w2` (Rộng dưới), `c` (mã màu).
- **`<blob>`**: Khối méo ngẫu nhiên hữu cơ dạng chất lỏng hoặc mây.
  *Thuộc tính:* `cx`, `cy` (Tâm), `rx`, `ry` (Bán kính bầu dục), `noise` (Độ méo nhiễu, Vd: 0.2), `c` (mã màu).

## Hậu Kỳ (Post-processing)
Áp dụng lên toàn bộ Canvas sau khi tất cả các layer đã được rải điểm. Bắt buộc đặt bên trong container `<postprocess>` ở **cuối file**. Đối với animation, hậu kỳ sẽ được áp dụng riêng biệt lên *từng frame* trước khi ghép lại thành Spritesheet.
- **`<outline>`**: Viền tự động.
  *Thuộc tính:* `sel-out` (True/False - nếu `true`, lấy màu vật thể làm viền rồi tô đậm đi và đổi tone màu), `thickness` (Độ dày), `color` (Nếu `sel-out="false"`, dùng màu gán sẵn, Vd: "#000000FF").
- **`<shadow>`** (hoặc `<directional-shadow>`): Đổ bóng ánh sáng toàn cục lên khối 2D.
  *Thuộc tính:* `dir` (Định hướng sáng: `top_left`, `top_right`...), `intensity` (Cường độ bóng 0.0 - 1.0).
- **`<jaggies>`** (hoặc `<jaggies-cleanup>`): Tự diệt các góc vuông bị cấn hạt hoặc đường răng cưa lỗi trên bản vẽ. Không có thuộc tính.

## Animation & Rigging (Hoạt Ảnh và Lắp Ráp)
PXVG hỗ trợ việc tái sử dụng linh kiện đồ họa thông qua cơ chế Bone & Rigging `<defs>` - `<use>`, giúp tiết kiệm token đáng kể và giữ vững tính liên tục (consistency) của nhân vật khi tạo Spritesheet. 

- **`<defs>`**: Đặt khối này ở phần đầu, là nơi khai báo (định nghĩa) các bộ phận. Nội dung trong `<defs>` **không được hiển thị ngay**.
- **`<group>`**: Gom một tập hợp các thẻ vẽ vật thể rời (VD: Cái đầu, Cánh tay). 
  *Thuộc tính:* `id` (Tên định danh, VD: "head"). 
- **`<animation>`**: Đánh dấu PXVG sẽ render ra một ảnh Spritesheet liên hoàn thay vì 1 ảnh tĩnh duy nhất.
  *Thuộc tính:* `name` (Tên hoạt ảnh, Vd: "walk_cycle"), `columns` (Số cột trong lưới xuất ra, mặc định bằng tổng số frame).
- **`<frame>`**: Định nghĩa một khung hình bên trong `<animation>`.
  *Thuộc tính:* `id` (Số thứ tự hoặc tên).
- **`<use>`**: Kéo thả khối `<group>` đã định nghĩa vào trong frame hoặc layer, hỗ trợ đẩy tọa độ hoặc lật chiều.
  *Thuộc tính:* `ref` (Gắn với `id` của `<group>`), `x` (đẩy trục ngang), `y` (đẩy trục dọc), `flip-x` ("true" / "false" - Khấu trừ phép lật trái phải).

**Ví dụ một Hoạt Ảnh Slime nảy:**
```xml
<pxvg w="32" h="32" xmlns="http://pixci.dev/pxvg">
  <palette>
    <color k="01" hex="#1A1C2CFF" />
    <color k="09" hex="#6ABE30FF" />
  </palette>
  
  <defs>
    <group id="slime_body"><dome cx="16" y="28" w="20" h="12" c="09" /></group>
    <group id="slime_eyes"><rect x="12" y="20" w="2" h="3" c="01" /></group>
  </defs>

  <animation name="bounce" columns="2">
    <!-- Frame 1: Đứng yên -->
    <frame id="1">
      <use ref="slime_body" />
      <use ref="slime_eyes" />
    </frame>
    <!-- Frame 2: Nảy lên (cả body và mắt dịch lên y="-4") -->
    <frame id="2">
      <use ref="slime_body" x="0" y="-4" />
      <use ref="slime_eyes" x="0" y="-4" />
    </frame>
  </animation>
  <postprocess><outline sel-out="false" color="#1A1C2CFF" thickness="1" /></postprocess>
</pxvg>
```
