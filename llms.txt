# PXVG (Pixel Vector Graphics)
> PXVG là một ngôn ngữ đánh dấu (Markup Language) dựa trên XML, được thiết kế đặc biệt làm mã trung gian (Static IR) để định nghĩa và sinh hình ảnh Pixel Art. PXVG cho phép định nghĩa các khối, đường nét, điểm ảnh lẻ và các hình học ngữ nghĩa một cách ngắn gọn, tối ưu hóa kích thước chuỗi (Token) và đảm bảo an toàn tuyệt đối khi parse.

## Cấu trúc gốc
Mọi file PXVG (lưu với đuôi `.pxvg.xml`) phải được bao bọc trong thẻ `<pxvg>` với các thuộc tính kích thước Canvas.
```xml
<pxvg w="32" h="32" xmlns="http://pixci.dev/pxvg">
  <!-- Nội dung bản vẽ -->
</pxvg>
```

## Bảng màu (Palette)
Định nghĩa các mã màu sử dụng trong bản vẽ. Có hai cách:
1. Sử dụng palette có sẵn (ví dụ: `endesga-32`, `pico-8`):
   `<palette load="endesga-32" />`
2. Tự định nghĩa các màu cụ thể (gắn mã key 1 ký tự để tiết kiệm token khi gọi):
   ```xml
   <palette>
     <color k="A" hex="#1C1C1EFF" />
     <color k="B" hex="#FF0000FF" />
   </palette>
   ```

## Hệ thống Lớp (Layers)
Các đối tượng đồ họa được phân rã theo lớp để quản lý trật tự vẽ (overlap). Các thẻ vẽ phải nằm trong thẻ `<layer>`.
```xml
<layer id="main">
  <!-- Chi tiết nét vẽ -->
</layer>
```

## Các Thẻ Hình Học Cơ Bản (Primitives)
*Mẹo Nhấn Mạnh:* Truyền `c="CLEAR"` vào BẤT KỲ thẻ nào dưới đây sẽ biến thẻ đó thành một **cục tẩy (Eraser)**, lập tức đục lẹm layer hiện tại thành trong suốt thay vì tô màu.
Các thẻ dùng để đổ màu lên ma trận điểm ảnh với tọa độ bắt buộc là **số nguyên (Integer)**.
- **`<rect>`**: Hình chữ nhật đặc.
  *Thuộc tính:* `x`, `y` (tọa độ góc trái trên), `w` (rộng), `h` (cao), `c` (mã màu).
- **`<row>`**: Chuỗi điểm ngang kéo dài liên tục trên 1 hàng y. (Dùng để tối ưu token).
  *Thuộc tính:* `y` (hàng), `x1` (cột bắt đầu), `x2` (cột kết thúc), `c` (mã màu).
- **`<dot>`**: Một điểm ảnh đơn lẻ.
  *Thuộc tính:* `x`, `y`, `c` (mã màu).
- **`<dots>`**: Tập hợp nhiều điểm ảnh đơn lẻ dùng chung một màu (siêu nén).
  *Thuộc tính:* `c` (mã màu), `pts` (chuỗi tọa độ "x,y x,y...").
- **`<line>`**: Đường thẳng vẽ bằng thuật toán Bresenham.
  *Thuộc tính:* `x1`, `y1` (Bắt đầu), `x2`, `y2` (Kết thúc), `thickness` (Hoặc `t="2"` độ dày nét), `c` (mã màu).
- **`<circle>`**: Hình tròn (thuật toán midpoint nén gai).
  *Thuộc tính:* `cx`, `cy` (tâm), `r` (bán kính), `fill` ("true"/"false"), `c` (mã màu).
- **`<ellipse>`**: Hình bầu dục tỷ lệ vàng.
  *Thuộc tính:* `cx`, `cy` (tâm), `rx`, `ry` (bán trục ngang, dọc), `fill` ("true"/"false"), `c`.
- **`<rounded-rect>`**: Hình chữ nhật bo góc viền.
  *Thuộc tính:* `x`, `y` (top-left), `w`, `h`, `r` (bán kính góc bo), `c`.
- **`<polygon>`**: Đa giác đặc.
  *Thuộc tính:* `pts` (chuỗi điểm "x,y x,y..."), `c` (mã màu).
- **`<curve>`**: Đường cong Bezier 3 điểm (pixel perfect).
  *Thuộc tính:* `start` ("x,y"), `ctrl` ("x,y"), `end` ("x,y"), `t` (độ dày nét), `c` (mã màu).
- **`<cubic-curve>`**: Đường cong Bezier 4 điểm.
  *Thuộc tính:* `p0`, `p1`, `p2`, `p3` (các tọa độ "x,y"), `t` (độ dày nét), `c`.
- **`<bucket>`**: Đổ thùng sơn lấp đầy khoảng trống kín.
  *Thuộc tính:* `x`, `y` (điểm mồi xuất phát), `c`.
- **`<dither>`**: Trộn 2 màu đục lỗ (Checkered pattern) tạo độ chuyển vùng.
  *Thuộc tính:* `x`, `y`, `w`, `h`, `c` (màu chính 1), `c2` (màu xen kẽ 2), `pattern` ("checkered", "bayer"), `ratio` (nếu dùng bayer).
- **`<gradient>`**: Phủ màu Gradient tuyến tính lên khu vực.
  *Thuộc tính:* `x`, `y`, `w`, `h`, `mode` ("vertical", "horizontal", "diagonal_down", "diagonal_up"), `palette` ("color_key_1,color_key_2,...").
- **`<noise>`**: Phủ các điểm sáng nhiễu hạt ngẫu nhiên (chỉ định vùng).
  *Thuộc tính:* `x`, `y`, `w`, `h`, `density` (0.0 -> 1.0, vd "0.5"), `palette` ("c1,c2").

## Thao Tác Biến Theo Từng Lớp (Transform & Alpha)
Sử dụng như một thẻ đơn độc lập bên trong layer hoặc frame `<layer>...<flip-x />...</layer>`
- **`<alpha-lock>`**: Bật/tắt chế độ khóa Alpha (Các lệnh rải điểm sau thẻ này sẽ chỉ ăn vào vùng ĐÃ CÓ MÀU).
  *Thuộc tính:* `v` ("true" / "false"). VD: `<alpha-lock v="true" />`
- **`<translate>`**: Dịch chuyển tịnh tiến. *Thuộc tính:* `dx`, `dy`.
- **`<flip-x>`**, **`<flip-y>`**: Lật ảnh.
- **`<mirror-x>`**, **`<mirror-y>`**: Sao chép nửa bức vẽ và tạo ảnh phản chiếu qua tâm gương tạc nắn đối xứng (rất đỉnh cho tạo hình body).

## Hậu Kỳ (Post-processing)
Áp dụng lên toàn bộ Canvas sau khi tất cả các layer đã được rải điểm. Bắt buộc đặt bên trong container `<postprocess>` ở **cuối file**. Đối với animation, hậu kỳ sẽ được áp dụng riêng biệt lên *từng frame* trước khi ghép lại thành Spritesheet.
- **`<outline>`**: Viền tự động.
  *Thuộc tính:* `sel-out` (True/False - nếu `true`, lấy màu vật thể làm viền rồi tô đậm đi và đổi tone màu), `thickness` (Độ dày), `color` (Nếu `sel-out="false"`, dùng màu gán sẵn, Vd: "#000000FF").
- **`<shadow>`** (hoặc `<directional-shadow>`): Đổ bóng ánh sáng toàn cục lên khối 2D.
  *Thuộc tính:* `dir` (Định hướng sáng: `top_left`, `top_right`...), `intensity` (Cường độ bóng 0.0 - 1.0).
- **`<jaggies>`** (hoặc `<jaggies-cleanup>`): Tự diệt các góc vuông bị cấn hạt hoặc đường răng cưa lỗi trên bản vẽ. Không có thuộc tính.
- **`<internal-aa>`**: Khử răng cưa (Anti-aliasing) nội sinh, tự vuốt mềm các đoạn ranh giới giao thoa giữa 2 màu nội bộ vật thể.
- **`<shadow-mask>`**: Phủ bóng tối bo cong dạng hình cầu khối hắt.
  *Thuộc tính:* `cx`, `cy` (tâm khối cầu), `r` (bán kính), `dir` (Hướng sáng `top_left`, vv...), `intensity` (0.0 -> 1.0).
- **`<highlight-edge>`**: Đường viền bắt sáng quang học (Rim Light) làm nổi tách vật thể.
  *Thuộc tính:* `dir`, `intensity`.

## Animation & Rigging (Hoạt Ảnh và Lắp Ráp)
PXVG hỗ trợ việc tái sử dụng linh kiện đồ họa thông qua cơ chế Bone & Rigging `<defs>` - `<use>`, giúp tiết kiệm token đáng kể và giữ vững tính liên tục (consistency) của nhân vật khi tạo Spritesheet. 

- **`<defs>`**: Đặt khối này ở phần đầu, là nơi khai báo (định nghĩa) các bộ phận. Nội dung trong `<defs>` **không được hiển thị ngay**.
- **`<group>`**: Gom một tập hợp các thẻ vẽ vật thể rời (VD: Cái đầu, Cánh tay). 
  *Thuộc tính:* `id` (Tên định danh, VD: "head"). 
- **`<animation>`**: Đánh dấu PXVG sẽ render ra một ảnh Spritesheet liên hoàn thay vì 1 ảnh tĩnh duy nhất.
  *Thuộc tính:* `name` (Tên hoạt ảnh, Vd: "walk_cycle"), `columns` (Số cột trong lưới xuất ra, mặc định bằng tổng số frame).
- **`<frame>`**: Định nghĩa một khung hình bên trong `<animation>`.
  *Thuộc tính:* `id` (Số thứ tự hoặc tên).
- **`<use>`**: Kéo thả khối `<group>` đã định nghĩa vào trong frame hoặc layer, hỗ trợ đẩy tọa độ hoặc lật chiều.
  *Thuộc tính:* `ref` (Gắn với `id` của `<group>`), `x` (đẩy trục ngang), `y` (đẩy trục dọc), `flip-x` ("true" / "false" - Khấu trừ phép lật trái phải).

**Ví dụ một Hoạt Ảnh Slime nảy:**
```xml
<pxvg w="32" h="32" xmlns="http://pixci.dev/pxvg">
  <palette>
    <color k="01" hex="#1A1C2CFF" />
    <color k="09" hex="#6ABE30FF" />
  </palette>
  
  <defs>
    <group id="slime_body">
      <rect x="6" y="22" w="20" h="7" c="09" />
      <row y="21" x1="8" x2="23" c="09" />
      <row y="20" x1="10" x2="21" c="09" />
    </group>
    <group id="slime_eyes"><rect x="12" y="20" w="2" h="3" c="01" /></group>
  </defs>

  <animation name="bounce" columns="2">
    <!-- Frame 1: Đứng yên -->
    <frame id="1">
      <use ref="slime_body" />
      <use ref="slime_eyes" />
    </frame>
    <!-- Frame 2: Nảy lên (cả body và mắt dịch lên y="-4") -->
    <frame id="2">
      <use ref="slime_body" x="0" y="-4" />
      <use ref="slime_eyes" x="0" y="-4" />
    </frame>
  </animation>
  <postprocess><outline sel-out="false" color="#1A1C2CFF" thickness="1" /></postprocess>
</pxvg>
```
